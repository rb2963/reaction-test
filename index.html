<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>반응속도 테스트</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background-color: #e0e0e0;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #circle-container {
    position: relative;
    margin-top: 120px;
  }

  .hint-container {
    position: absolute;
    top: -55px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
  }

  .hint {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    color: white;
    font-weight: bold;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 14px;
  }

  .red { background: red; }
  .green { background: green; }
  .blue { background: blue; }

  #main-circle {
    width: 200px;
    height: 200px;
    border-radius: 50%;
    background-color: white;
    border: 5px solid black;
  }

  #message {
    margin-top: 25px;
    font-size: 22px;
    height: 30px;
  }

  #average-text {
    font-size: 20px;
    margin-top: 10px;
  }

  #graph-box {
    width: 900px;
    height: 500px;
    margin-top: 40px;
    display: none;
  }
</style>
</head>

<body>

<div id="circle-container">
  <div class="hint-container">
    <div class="hint red">A</div>
    <div class="hint green">S</div>
    <div class="hint blue">D</div>
  </div>
  <div id="main-circle"></div>
</div>

<div id="message">스페이스바를 눌러 시작</div>
<div id="average-text"></div>

<div id="graph-box">
  <canvas id="resultChart"></canvas>
</div>

<script>
const circle = document.getElementById("main-circle");
const message = document.getElementById("message");
const avgText = document.getElementById("average-text");

const COLORS = [
  { color: "red", key: "a" },
  { color: "green", key: "s" },
  { color: "blue", key: "d" }
];

const MAX_TRIALS = 10;

let trial = 0;
let results = [];
let waiting = false;
let startTime = 0;
let currentColor = null;
let colorTimer = null;
let finished = false;
let chartInstance = null;

// 동시 입력 판정
let firstKey = null;
let firstKeyTime = null;
let confirmTimer = null;
let simultaneousDetected = false;

function randomDelay() {
  return Math.random() * 3000 + 3000;
}

function resetKeyDetection() {
  firstKey = null;
  firstKeyTime = null;
  confirmTimer = null;
  simultaneousDetected = false;
}

function startTrial() {
  clearTimeout(colorTimer);
  resetKeyDetection();

  circle.style.backgroundColor = "white";
  currentColor = null;
  waiting = false;

  colorTimer = setTimeout(() => {
    const choice = COLORS[Math.floor(Math.random() * COLORS.length)];
    currentColor = choice;
    circle.style.backgroundColor = choice.color;
    startTime = performance.now();
    waiting = true;
  }, randomDelay());
}

function showPenalty(text) {
  document.body.style.backgroundColor = "#555";
  message.textContent = text;

  setTimeout(() => {
    document.body.style.backgroundColor = "#e0e0e0";
    message.textContent = "";
    startTrial();
  }, 1000);
}

function handleValidInput(key, time) {
  if (key !== currentColor.key) return;

  const reaction = time - startTime;
  results.push(reaction);
  trial++;

  message.textContent = `${trial}회차: ${reaction.toFixed(1)} ms`;

  if (trial >= MAX_TRIALS) {
    showGraph();
  } else {
    startTrial();
  }
}

document.addEventListener("keydown", (e) => {

  // 결과 화면 → 스페이스로 재시작
  if (finished && e.code === "Space") {
    finished = false;
    trial = 0;
    results = [];
    avgText.textContent = "";
    document.getElementById("graph-box").style.display = "none";
    message.textContent = "";
    startTrial();
    return;
  }

  // 최초 시작
  if (!finished && trial === 0 && !waiting && e.code === "Space") {
    message.textContent = "";
    startTrial();
    return;
  }

  // 흰색 원일 때 입력
  if (!waiting) {
    showPenalty("너무 빨라요");
    return;
  }

  const now = performance.now();

  // 첫 입력
  if (firstKeyTime === null) {
    firstKeyTime = now;
    firstKey = e.key;
    simultaneousDetected = false;

    confirmTimer = setTimeout(() => {
      if (!simultaneousDetected) {
        handleValidInput(firstKey, firstKeyTime);
        resetKeyDetection();
      }
    }, 5);

    return;
  }

  // 5ms 이내 다른 키 → 동시입력
  if (now - firstKeyTime <= 5 && e.key !== firstKey) {
    simultaneousDetected = true;
    clearTimeout(confirmTimer);
    resetKeyDetection();
    showPenalty("동시 입력 감지");
  }
});

function showGraph() {
  finished = true;
  waiting = false;

  document.getElementById("graph-box").style.display = "block";

  const avg = results.reduce((a, b) => a + b, 0) / results.length;
  avgText.textContent = `평균 반응속도: ${avg.toFixed(1)} ms`;
  message.textContent = "스페이스바를 눌러 다시 시작";

  const ctx = document.getElementById("resultChart");

  if (chartInstance) chartInstance.destroy();

  chartInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels: results.map((_, i) => `${i + 1}회`),
      datasets: [
        {
          label: "평균",
          data: results.map(() => avg),
          borderColor: "black",
          borderWidth: 2,
          pointRadius: 0,
          order: 0
        },
        {
          label: "결과",
          data: results,
          borderWidth: 3,
          tension: 0.25,
          pointRadius: 6,
          pointHoverRadius: 8,
          order: 1
        }
      ]
    },
    options: {
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.raw.toFixed(1)} ms`
          }
        }
      },
      scales: {
        y: { beginAtZero: false }
      }
    }
  });
}
</script>

</body>
</html>
